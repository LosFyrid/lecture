id: context-101-sessions
title: "Context Engineering（上）：Sessions 与长任务状态管理"
summary: |
  把“上下文=prompt”升级为“上下文工程”：动态构造模型输入；用 session 承载任务状态与多步轨迹；理解长上下文的取舍与多 agent 的共享/私有上下文问题。
items:
  - type: md
    title: 学习目标
    body: |
      学完本课，你应该能够：

      - 解释 Context Engineering 的核心：**决定哪些信息进入模型输入、以什么结构进入、何时更新/压缩/检索补充**。
      - 说清楚 session 的作用：让 LLM（天然无状态）在多轮/长任务中保持连续性。
      - 列出长上下文管理的关键 tradeoffs：成本、噪声累积、关键信息丢失风险。
      - 理解 multi-agent 下 session 的额外难点：共享状态、冲突、污染、互操作。

  - type: md
    title: 心智模型：Context Engineering 不是写 prompt，而是“构造输入”
    body: |
      LLM 天生无状态：每次 API call 只看见你给它的 context window。

      因此 agent 要“记得住、做得长、保持一致”，关键不是把 prompt 写得更长，而是：

      - **动态组装**：system instructions + 任务状态 + 对话历史 + 检索信息 + 关键约束
      - **按需压缩**：长对话一定会超 context window，需要摘要/裁剪/分层保留
      - **降低噪声**：更多上下文不一定更好；错误/幻觉也会被带入并放大

      你可以用一个比喻记住它（来自白皮书）：  
      Context Engineering 像做菜的 *mise en place* —— 不只是给菜谱，而是把合适的食材/工具/步骤准备好。

  - type: md
    title: Sessions：让 agent “有状态”但不失控
    body: |
      session 可以理解为“任务进行中的状态容器”，通常包含：

      - 对话历史（chronological history）
      - 当前任务状态（目标、约束、已完成/待完成子任务）
      - 工具调用结果的摘要（observations）
      - 必要的工作记忆（scratchpad）

      你需要做的关键工程选择：

      - **状态粒度**：哪些字段必须显式保存？（科研建议：目标、约束、单位、数据来源、关键中间结果）
      - **写入策略**：每步写入 vs 关键节点写入（影响成本与可追溯性）
      - **压缩策略**：摘要/裁剪如何保持“关键约束不丢”
      - **可移植性/互操作**：不同框架的 session 表示差异很大，需提前抽象 schema

  - type: html
    title: Multi-Agent 场景下的 Sessions：必须回答的 3 个问题
    note: 学界 multi-agent 很常见；如果 session 设计不清晰，系统会很快变成“不可解释的聊天噪声”。
    body: |
      <div style="border:1px solid rgba(0,0,0,.12); border-radius:12px; padding:12px; line-height:1.65;">
        <div style="font-weight:600; margin-bottom:6px;">问题 1：共享状态是谁的“真相源”（source of truth）？</div>
        <div>由哪个角色写入？其他角色只能读，还是也能写？冲突如何解决？</div>
        <div style="height:10px;"></div>
        <div style="font-weight:600; margin-bottom:6px;">问题 2：哪些信息必须私有？</div>
        <div>例如工作草稿/中间猜想/未验证结论：过早共享会污染系统并放大错误。</div>
        <div style="height:10px;"></div>
        <div style="font-weight:600; margin-bottom:6px;">问题 3：如何终止与收敛？</div>
        <div>需要明确停止条件、最大步数/预算、何时向人请求澄清或确认。</div>
      </div>

  - type: md
    title: 长上下文对话：tradeoffs 与常见策略（研究视角）
    body: |
      你必须接受：长任务中上下文永远不够用。策略的本质是“取舍”。

      常见策略（可作为研究变量去比较）：

      - **分层保留**：把信息分为“必须不丢/可摘要/可丢弃”
      - **摘要可追溯**：摘要需要指向原始 evidence（为后续 provenance 做准备）
      - **按需检索补充**：不要把所有东西塞进上下文；需要时检索，再做压缩

      对科研任务的建议：把“单位、数据来源、实验条件、样品编号”等当作**硬约束**，绝不能被摘要丢掉。

  - type: md
    layout: inline
    body: |
      原文节选建议：

      - 源 PDF：`Context Engineering_ Sessions & Memory.pdf`
      - 建议裁剪页码：第 **6–26** 页（对应章节：Context Engineering / Sessions / multi-agent sessions / interoperability / long context tradeoffs）

      裁剪后上传到 S3，再把下面 `assetKey` 更新为你的对象 key。
  - type: pdf
    title: "原文节选：Context Engineering（第 6–26 页）"
    assetKey: pdf/excerpts/Context_Engineering.p6-26.pdf

